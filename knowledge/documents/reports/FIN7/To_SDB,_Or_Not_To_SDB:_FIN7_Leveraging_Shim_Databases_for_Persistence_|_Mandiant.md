# Reference for threat actor for "FIN7"

**Title**: To SDB, Or Not To SDB: FIN7 Leveraging Shim Databases for Persistence | Mandiant

**Source**: https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html

## Content
To SDB, Or Not To SDB: FIN7 Leveraging Shim Databases for Persistence | Mandiant   Skip to main content Mandiant is now part of Google Cloud. Learn More.         Platform   Solutions   Intelligence   Services   Resources   Company Mandiant AdvantageExplore our multi-vendor XDR platform, delivering Mandiant products and integrating with a range of leading security operations technology.Explore the platformarrow_forward Who's targeting you   Attack Surface Management Map your external environment   Breach Analytics for Chronicle Know what we know when we know it   Security Validation Validate controls are working properly   Threat Intelligence Access latest intel from the frontlines   Digital Threat Monitoring Visibility into deep, dark, and open web   Managed Defense Managed detection and response Mandiant SolutionsSolve your toughest cyber security challenges with combinations of products and services.Featured solutionsarrow_forwardBy use casearrow_forwardBy industryarrow_forward  Featured solutions   Proactive Exposure Management New!Reduce exposures before adversaries act   Government New!Protect national services and agencies   Digital Risk ProtectionPrioritize and focus on threats that matter   RansomwareIncrease resilience against ransomware and multifaceted extortion   Know Who is Targeting YouPrioritize threats that matter most   Know What Is ExposedIdentify attack surface exposures   Know If You Are PreparedTest and measure your cyber defense program   Know If You Have Been BreachedDetect and respond to breach activity quickly and effectively   Use Case   RansomwareIncrease resilience against multifaceted extortion   Cyber Risk ManagementAdvance your business approach to cyber security   Digital Risk ProtectionPrioritize and focus on threats that matter   Industrial ControlsStrengthen OT and ICS security   Insider ThreatsUncover and manage internal vulnerabilities   Skills GapClose gaps with training and access to expertise   Private Industry   Finance New!Extend your security posture and operationalize resilience   Manufacturing New!Protect against cyber security threats to maintain business continuity   Government   Election SecurityFocus on Election Infrastructure Protection   Government  New!Protect natural services and agencies Mandiant ServicesMitigate threats, reduce risk, and get back to business with the help of leading experts.Learn morearrow_forwardView all services (47)arrow_forward Schedule a consultation   Featured categories   Cyber Security Transformation Establish and activate cyber defenses   Incident Response Tackle breaches confidently   Strategic Readiness Increase resilience to risk   Technical Assurance Test your security program   Expertise On Demand Access to Mandiant Experts   Training   Browse courses Browse on-demand and live training   Mandiant Academy Train your teams to protect effectively Cyber Threat IntelligenceMandiant specializes in cyber threat intelligence, offering products, services, and more to support our mission to defend against cyber crime. Intelligence resourcesarrow_forward  Products   Threat Intelligence Access latest intel from the frontlines   Digital Threat Monitoring visibility into deep, dark, and open web   Services   Intelligence capability development build a comprehensive threat intelligence program   Intelligence Training Develop practical application skills   Executive Briefings Get live, interactive briefings from the frontlines   Advanced Intelligence Access Hire a dedicated analyst for your needs Resource CenterGet the latest insights from cyber security experts at the frontlines of threat intelligence and incident responseM-Trends 2023 reportarrow_forwardmWISEarrow_forward View all resourcesarrow_forward   Resource types   Mandiant Blog Expert perspectives and industry news   Podcasts Interviews, hot topics, and more   Customer Stories Case studies and customer testimonials   Reports Research from the frontlines   Webinars Livestreams and pre-recorded speaker events   Insights Cyber security concepts, methods, and more   Events Upcoming conferences and collaboration   Infographics Visualization of security research and process   Datasheets Information on Mandiant offerings and more   eBooks High-impact cyber security guides   White Papers Cyber security insights and technical expertise CompanyLearn more about us and our mission to help organizations defend against cyber crime.Learn morearrow_forward Contact us   Careers Life at Mandiant and open roles   Media Center Press releases and news mentions   Partners Ecosystem and resources   Elevate Empowering women in cyber security   Mandiant Gives Back Our commitment to a better future              Sign in to Advantage  en  expand_more   English Français Deutsch Italiano 日本 한국어 EspañolGet Started        Search   Submit search form    Search   Submit search form  PlatformMandiant Advantage OverviewSecurity ValidationAttack Surface ManagementThreat IntelligenceDigital Threat MonitoringManaged DefenseSolutionsProactive Exposure ManagementGovernmentRansomwareKnow Who is Targeting YouKnow What Is ExposedKnow If You Are PreparedKnow If You Have Been BreachedCyber Risk ManagementDigital Risk ProtectionOT/ICS SecurityInsider ThreatsCyber Security Skills GapFinanceManufacturingElection SecurityIntelligenceIntelligence resourcesThreat IntelligenceDigital Threat MonitoringIntelligence Capability DevelopmentIntelligence TrainingExecutive BriefingsAdvanced Intelligence AccessServicesServices OverviewIncident ResponseStrategic ReadinessCyber Security TransformationTechnical AssuranceView all Services (48)Mandiant AcademyFind a CourseExpertise On DemandResourcesResourcesMandiant BlogsCustomer StoriesWebinarsEventsPodcastsReportsInsightsDatasheetsInfographicsWhite PaperseBooksCompanyAbout MandiantCareersMedia CenterPartnersElevateMandiant Gives BackMobile Footer SectionSee what’s new at MandiantGet startedIncident Response HelpContact SalesSupportBlogTop Incident Response Contact sales Support   BlogSupportContact usreport_problemIncident Response Assistance   Breadcrumb Home To SDB, Or Not To SDB: FIN7 Leveraging Shim Databases for Persistence   Threat Research To SDB, Or Not To SDB: FIN7 Leveraging Shim Databases for PersistenceMatthew McWhirt, Jon Erickson, DJ Palombo May 03, 20174 min read |    Last updated: Nov 04, 2021 In 2017, Mandiant responded to multiple incidents we attribute to FIN7, a financially motivated threat group associated with malicious operations dating back to 2015. Throughout the various environments, FIN7 leveraged the CARBANAK backdoor, which this group has used in previous operations.A unique aspect of the incidents was how the group installed the CARBANAK backdoor for persistent access. Mandiant identified that the group leveraged an application shim database to achieve persistence on systems in multiple environments. The shim injected a malicious in-memory patch into the Services Control Manager (“services.exe”) process, and then spawned a CARBANAK backdoor process.Mandiant identified that FIN7 also used this technique to install a payment card harvesting utility for persistent access. This was a departure from FIN7’s previous approach of installing a malicious Windows service for process injection and persistent access.Application Compatibility Shims BackgroundAccording to Microsoft, an application compatibility shim is a small library that transparently intercepts an API (via hooking), changes the parameters passed, handles the operation itself, or redirects the operation elsewhere, such as additional code stored on a system. Today, shims are mainly used for compatibility purposes for legacy applications. While shims serve a legitimate purpose, they can also be used in a malicious manner. Mandiant consultants previously discussed shim databases at both BruCon and BlackHat.Shim Database RegistrationThere are multiple ways to register a shim database on a system. One technique is to use the built-in “sdbinst.exe” command line tool. Figure 1 displays the two registry keys created when a shim is registered with the “sdbinst.exe” utility.Figure 1: Shim database registry keysOnce a shim database has been registered on a system, the shim database file (“.sdb” file extension) will be copied to the “C:\Windows\AppPatch\Custom” directory for 32-bit shims or “C:\Windows\AppPatch\Custom\Custom64” directory for 64-bit shims.Malicious Shim Database InstallationTo install and register the malicious shim database on a system, FIN7 used a custom Base64 encoded PowerShell script, which ran the “sdbinst.exe” utility to register a custom shim database file containing a patch onto a system. Figure 2 provides a decoded excerpt from a recovered FIN7 PowerShell script showing the parameters for this command.Figure 2: Excerpt from a FIN7 PowerShell script to install a custom shimFIN7 used various naming conventions for the shim database files that were installed and registered on systems with the “sdbinst.exe” utility. A common observance was the creation of a shim database file with a “.tmp” file extension (Figure 3).Figure 3: Malicious shim database exampleUpon registering the custom shim database on a system, a file named with a random GUID and an “.sdb” extension was written to the 64-bit shim database default directory, as shown in Figure 4. The registered shim database file had the same MD5 hash as the file that was initially created in the “C:\Windows\Temp” directory.Figure 4: Shim database after registrationIn addition, specific registry keys were created that correlated to the shim database registration.  Figure 5 shows the keys and values related to this shim installation.Figure 5: Shim database registry keysThe database description used for the shim database registration, “Microsoft KB2832077” was interesting because this KB number was not a published Microsoft Knowledge Base patch. This description (shown in Figure 6) appeared in the listing of installed programs within the Windows Control Panel on the compromised system.Figure 6: Shim database as an installed applicationMalicious Shim Database DetailsDuring the investigations, Mandiant observed that FIN7 used a custom shim database to patch both the 32-bit and 64-bit versions of “services.exe” with their CARBANAK payload. This occurred when the “services.exe” process executed at startup. The shim database file contained shellcode for a first stage loader that obtained an additional shellcode payload stored in a registry key. The second stage shellcode launched the CARBANAK DLL (stored in a registry key), which spawned an instance of Service Host (“svchost.exe”) and injected itself into that process.  Figure 7 shows a parsed shim database file that was leveraged by FIN7.Figure 7: Parsed shim database fileFor the first stage loader, the patch overwrote the “ScRegisterTCPEndpoint” function at relative virtual address (RVA) “0x0001407c” within the services.exe process with the malicious shellcode from the shim database file. The new “ScRegisterTCPEndpoint” function (shellcode) contained a reference to the path of “\REGISTRY\MACHINE\SOFTWARE\Microsoft\DRM”, which is a registry location where additional malicious shellcode and the CARBANAK DLL payload was stored on the system.Figure 8 provides an excerpt of the parsed patch structure within the recovered shim database file.Figure 8: Parsed patch structure from the shim database fileThe shellcode stored within the registry path “HKLM\SOFTWARE\Microsoft\DRM” used the API function “RtlDecompressBuffer” to decompress the payload. It then slept for four minutes before calling the CARBANAK DLL payload's entry point on the system. Once loaded in memory, it created a new process named “svchost.exe” that contained the CARBANAK DLL. Bringing it TogetherFigure 9 provides a high-level overview of a shim database being leveraged as a persistent mechanism for utilizing an in-memory patch, injecting shellcode into the 64-bit version of “services.exe”.Figure 9: Shim database code injection processDetectionMandiant recommends the following to detect malicious application shimming in an environment:Monitor for new shim database files created in the default shim database directories of “C:\Windows\AppPatch\Custom” and “C:\Windows\AppPatch\Custom\Custom64”Monitor for registry key creation and/or modification events for the keys of “HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom” and “HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\InstalledSDB”Monitor process execution events and command line arguments for malicious use of the “sdbinst.exe” utility  Link to RSS feedPrepare for 2024's cybersecurity landscape.Get the Google Cloud Cybersecurity Forecast 2024 report to explore the latest trends on the horizon. Download now  Have questions? Let's talk.Mandiant experts are ready to answer your questions. Contact Us  Follow us Footer Mandiant Advantage Platform Platform Overview Security Validation Attack Surface Management Threat Intelligence Digital Threat Monitoring Managed Defense Solutions Proactive Exposure Management Ransomware Industrial Controls & OT Cyber Risk Management Digital Risk Protection Insider Threats Cyber Security Skills Gap Election Security Government Cyber Security Manufacturing Cyber Threat Visibility Attack Surface Visibility Cyber Preparedness Detection and Response Financial Services Cyber Security Services Services Overview Incident Response Strategic Readiness Cyber Security Transformation Technical Assurance View all Services (48) Expertise on Demand Mandiant Academy Overview Education Formats Upcoming Courses On-Demand Courses Certifications ThreatSpace Cyber Range Free Course Sneak Peaks Resources Resource Center Blog Podcasts  Customer Stories Reports Webinars Insights eBooks Infographics White Papers Datasheets Company About Us Careers Events Media Center Partners Partners Overview Technology Partners Cyber Risk Partners Service Partners Channel Partners Partner Portal Connect with Mandiant Contact Us Report an Incident Customer Support Customer Success Media Inquiries © Copyright 2024 Mandiant. All rights reserved.Bottom Website Privacy Policy Terms & Conditions Compliance Site Map  